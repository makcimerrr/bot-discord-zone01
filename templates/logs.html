{% extends "base.html" %}

{% block title %}Logs - Bot Discord Zone01{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-white text-center mb-4">
            <i class="bi bi-file-text"></i> Logs du Bot
        </h1>
    </div>
</div>

<!-- Statistiques des Logs -->
<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="stat-card">
            <div class="stat-icon text-secondary">
                <i class="bi bi-file-earmark-text"></i>
            </div>
            <div class="stat-value text-secondary">{{ stats.total }}</div>
            <div class="stat-label">Total</div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="stat-card">
            <div class="stat-icon text-primary">
                <i class="bi bi-info-circle"></i>
            </div>
            <div class="stat-value text-primary">{{ stats.info }}</div>
            <div class="stat-label">Info</div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="stat-card">
            <div class="stat-icon text-success">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-value text-success">{{ stats.success }}</div>
            <div class="stat-label">Succès</div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="stat-card">
            <div class="stat-icon text-warning">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stat-value text-warning">{{ stats.warning }}</div>
            <div class="stat-label">Warnings</div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="stat-card">
            <div class="stat-icon text-danger">
                <i class="bi bi-x-circle"></i>
            </div>
            <div class="stat-value text-danger">{{ stats.error }}</div>
            <div class="stat-label">Erreurs</div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="stat-card">
            <div class="stat-icon text-muted">
                <i class="bi bi-bug"></i>
            </div>
            <div class="stat-value text-muted">{{ stats.debug }}</div>
            <div class="stat-label">Debug</div>
        </div>
    </div>
</div>

<!-- Filtres -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-funnel"></i> Filtres
            </div>
            <div class="card-body">
                <form id="filter-form" class="row g-3">
                    <div class="col-md-3">
                        <label for="level-filter" class="form-label">Niveau</label>
                        <select class="form-select" id="level-filter">
                            <option value="">Tous</option>
                            <option value="INFO">Info</option>
                            <option value="SUCCESS">Succès</option>
                            <option value="WARNING">Warning</option>
                            <option value="ERROR">Erreur</option>
                            <option value="DEBUG">Debug</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="category-filter" class="form-label">Catégorie</label>
                        <select class="form-select" id="category-filter">
                            <option value="">Toutes</option>
                            <option value="bot">Bot</option>
                            <option value="cog">Cog</option>
                            <option value="help_system">Système d'Aide</option>
                            <option value="help_button">Bouton d'Aide</option>
                            <option value="notion">Notion</option>
                            <option value="general">Général</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="limit-filter" class="form-label">Limite</label>
                        <select class="form-select" id="limit-filter">
                            <option value="50">50 derniers</option>
                            <option value="100" selected>100 derniers</option>
                            <option value="200">200 derniers</option>
                            <option value="500">500 derniers</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="bi bi-search"></i> Filtrer
                            </button>
                            <button type="button" class="btn btn-danger" onclick="clearLogs()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Liste des Logs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list"></i> Logs Récents</span>
                <button class="btn btn-sm btn-light" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
            </div>
            <div class="card-body p-0">
                <div id="logs-container" style="max-height: 600px; overflow-y: auto;">
                    {% if logs %}
                    <table class="table table-hover table-sm mb-0">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th style="width: 180px;">Date/Heure</th>
                                <th style="width: 100px;">Niveau</th>
                                <th style="width: 120px;">Catégorie</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            {% for log in logs %}
                            <tr>
                                <td>
                                    <small class="text-muted">
                                        {{ log.timestamp|format_log_timestamp }}
                                    </small>
                                </td>
                                <td>
                                    {% if log.level == "INFO" %}
                                    <span class="badge bg-primary">
                                        <i class="bi bi-info-circle"></i> INFO
                                    </span>
                                    {% elif log.level == "SUCCESS" %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> SUCCESS
                                    </span>
                                    {% elif log.level == "WARNING" %}
                                    <span class="badge bg-warning">
                                        <i class="bi bi-exclamation-triangle"></i> WARNING
                                    </span>
                                    {% elif log.level == "ERROR" %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-circle"></i> ERROR
                                    </span>
                                    {% elif log.level == "DEBUG" %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-bug"></i> DEBUG
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ log.category }}</span>
                                </td>
                                <td>{{ log.message }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                        <h5 class="text-muted mt-3">Aucun log disponible</h5>
                        <p class="text-muted">Les logs du bot apparaîtront ici.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Légende -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Légende des Niveaux
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <span class="badge bg-primary mb-2">INFO</span>
                        <p class="small text-muted">Informations générales</p>
                    </div>
                    <div class="col-md-2">
                        <span class="badge bg-success mb-2">SUCCESS</span>
                        <p class="small text-muted">Opération réussie</p>
                    </div>
                    <div class="col-md-2">
                        <span class="badge bg-warning mb-2">WARNING</span>
                        <p class="small text-muted">Avertissement</p>
                    </div>
                    <div class="col-md-2">
                        <span class="badge bg-danger mb-2">ERROR</span>
                        <p class="small text-muted">Erreur critique</p>
                    </div>
                    <div class="col-md-2">
                        <span class="badge bg-secondary mb-2">DEBUG</span>
                        <p class="small text-muted">Débogage</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function applyFilters() {
        const level = document.getElementById('level-filter').value;
        const category = document.getElementById('category-filter').value;
        const limit = document.getElementById('limit-filter').value;

        let url = '/logs?';
        if (level) url += `level=${level}&`;
        if (category) url += `category=${category}&`;
        if (limit) url += `limit=${limit}`;

        window.location.href = url;
    }

    function refreshLogs() {
        applyFilters();
    }

    function clearLogs() {
        if (confirm('Êtes-vous sûr de vouloir effacer tous les logs ?')) {
            fetch('/api/logs/clear', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erreur lors de la suppression des logs');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la suppression des logs');
                });
        }
    }

    // Actualisation automatique toutes les 15 secondes
    setInterval(refreshLogs, 15000);
</script>
{% endblock %}
